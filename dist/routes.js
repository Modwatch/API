"use strict";var Modlist=require("./modlist.js"),supportedFiletypes=["plugins","modlist","ini","prefsini","skse","enblocal"],validFiletype=function(e){return supportedFiletypes.indexOf(e)>=0},tokenEnsureAuthorized=function(e,n,t){var i,s=e.headers.authorization;if("undefined"!=typeof s){var o=s.split(" ");i=o[1],e.token=i,t()}else n.sendStatus(403)};module.exports=function(e,n,t){e.get("/api/users/count",function(e,n){Modlist.find({},{_id:1},function(e,t){t?(n.set("Content-Type","text/plain"),n.send(""+t.length)):(n.writeHead(404),n.end())})}),e.get("/api/users/list",function(e,n){Modlist.find({},{username:1,timestamp:1,score:1},function(e,t){for(var i=[],s=t.length-1,o=0;s>=0;s--,o++)i[o]={username:t[s].username,score:t[s].score,timestamp:t[s].timestamp};n.set("Content-Type","application/json"),n.send(i)})}),e.get("/api/script/version",function(e,n){n.set("Content-Type","text/plain"),n.end(t[.2])}),e.get("/api/script/version/3",function(e,n){n.set("Content-Type","text/plain"),n.end(t[.3])}),e.get("/api/user/:username/file/:filetype",function(e,n){if(validFiletype(e.params.filetype)){var t={};t[e.params.filetype]=1,Modlist.findOne({username:e.params.username},t,function(t,i){i?(i.shrinkArrays(),n.setHeader("Content-Type","application/json"),n.end(JSON.stringify(i[e.params.filetype]))):(n.writeHead(404),n.end())})}else n.sendStatus(500)}),e.get("/api/user/:username/rawfile/:filetype",function(e,n){if(validFiletype(e.params.filetype)){var t={};t[e.params.filetype]=1,Modlist.findOne({username:e.params.username},t,function(t,i){if(i){i.shrinkArrays(),n.setHeader("Content-Type","text/plain");for(var s=[],o=0;o<i[e.params.filetype].length;o++)s.push(i[e.params.filetype][o]);n.end(s.join("\n"))}else n.writeHead(404),n.end()})}else n.sendStatus(500)}),e.get("/api/user/:username/profile",function(e,n){Modlist.findOne({username:e.params.username},{tag:1,enb:1,badge:1,timestamp:1,game:1,score:1,_id:0},function(e,t){t?(n.setHeader("Content-Type","application/json"),n.end(JSON.stringify(t))):(n.writeHead(404),n.end())})}),e.get("/api/user/:username/files",function(e,n){Modlist.findOne({username:e.params.username},{plugins:1,modlist:1,ini:1,prefsini:1,skse:1,enblocal:1,_id:0},function(e,t){if(t){n.setHeader("Content-Type","application/json");var i=[];t.plugins.length>0&&i.push("plugins"),t.modlist.length>0&&i.push("modlist"),t.ini.length>0&&i.push("ini"),t.prefsini.length>0&&i.push("prefsini"),t.skse.length>0&&i.push("skse"),t.enblocal.length>0&&i.push("enblocal"),n.end(JSON.stringify(i))}else n.writeHead(404),n.end()})}),e.get("/api/search/file/:filetype/:querystring",function(e,n){if(validFiletype(e.params.filetype)){var t={username:1};t[e.params.filetype]=1,Modlist.find({},t,function(t,i){for(var s,o=[],r=e.params.querystring.toLowerCase(),a=0;i&&a<i.length;a++){i[a].shrinkArrays();for(var d=0;d<i[a][e.params.filetype].length;d++)if(s=i[a][e.params.filetype][d].toLowerCase(),s.indexOf(r)>=0){o.push(i[a].username);break}}n.setHeader("Content-Type","application/json"),n.end(JSON.stringify({users:o,length:o.length}))})}else n.sendStatus(500)}),e.post("/auth/checkToken",function(e,t){n.verify(e.body.token,process.env.JWTSECRET,function(e,n){e?(t.writeHead(403),t.end()):(t.setHeader("Content-Type","application/json"),t.end(JSON.stringify({username:n.username})))})}),e.post("/auth/signin",function(e,t){Modlist.findOne({username:e.body.username},function(i,s){i?(t.writeHead(500),t.end()):s&&s.validPassword(e.body.password)?(s.pic=n.sign({username:s.username,password:s.password},process.env.JWTSECRET,{expiresInMinutes:720}),s.save(function(e,n){e?(t.writeHead(500),t.end()):t.json({token:n.pic})})):(t.writeHead(403),t.end())})}),e.post("/api/newTag/:username",tokenEnsureAuthorized,function(e,t){n.verify(e.token,process.env.JWTSECRET,function(n,i){n?(t.writeHead(403),t.end()):Modlist.findOne({username:e.params.username},function(n,i){i?(i.tag=e.body.tag,i.save(function(e){e?(t.writeHead(500),t.end()):(t.statusCode=200,t.end())})):(t.writeHead(404),t.end())})})}),e.post("/api/newENB/:username",tokenEnsureAuthorized,function(e,t){n.verify(e.token,process.env.JWTSECRET,function(n,i){n?(t.writeHead(403),t.end()):Modlist.findOne({username:e.params.username},function(n,i){i?(i.enb=e.body.enb,i.save(function(e){e?(t.writeHead(500),t.end()):(t.statusCode=200,t.end())})):(t.writeHead(404),t.end())})})}),e.post("/auth/upvote/:votee",tokenEnsureAuthorized,function(e,t){n.verify(e.token,process.env.JWTSECRET,function(n,i){n?(t.writeHead(403),t.write("jwt verification error"),t.end()):i.username===e.params.votee?(t.writeHead(403),t.write("You can't vote for yourself"),t.end()):i?Modlist.findOne({username:i.username},function(n,i){var s=i.votedOnUser(e.params.votee);i&&!s.upvoted?Modlist.findOne({username:e.params.votee},function(n,o){o?(-1===s.index?o.score+=1:o.score+=2,o.save(function(e){e?(t.writeHead(500),t.write("Error saving votee info"),t.end()):(t.setHeader("Content-Type","application/json"),t.end(JSON.stringify({score:o.score})))}),-1!==s.index?i.votedon[s.index].upvoted=!0:i.votedon.push({username:e.params.votee,upvoted:!0}),i.save(function(e){e?console.log(e):console.log("Saved voter.votedon")})):(t.writeHead(404),t.write("jwt verification error"),t.end())}):(t.writeHead(403),i?t.write("Voter already voted"):t.write("Voter not found"),t.end())}):(t.writeHead(403),t.write("Voter not found"),t.end())})}),e.post("/auth/downvote/:votee",tokenEnsureAuthorized,function(e,t){n.verify(e.token,process.env.JWTSECRET,function(n,i){n?(t.writeHead(403),t.write("jwt verification error"),t.end()):i.username===e.params.votee?(t.writeHead(403),t.write("Why would you downvote yourself?"),t.end()):i?Modlist.findOne({username:i.username},function(n,i){var s=i.votedOnUser(e.params.votee);i&&(-1===s.index||s.upvoted)?Modlist.findOne({username:e.params.votee},function(n,o){o?(-1===s.index?o.score-=1:o.score-=2,o.save(function(e){e?(t.writeHead(500),t.write("Error saving votee info"),t.end()):(t.setHeader("Content-Type","application/json"),t.end(JSON.stringify({score:o.score})))}),-1!==s.index?i.votedon[s.index].upvoted=!1:i.votedon.push({username:e.params.votee,upvoted:!1}),i.save(function(e){e?console.log(e):console.log("Saved voter.votedon")})):(t.writeHead(404),t.write("jwt verification error"),t.end())}):(t.writeHead(403),i?t.write("Voter already voted"):t.write("Voter not found"),t.end())}):(t.writeHead(403),t.write("Voter not found"),t.end())})}),e.post("/loadorder",function(e,n){Modlist.findOne({username:e.body.username},function(t,i){if(i)i.validPassword(e.body.password)?((i.list||i.modlisttxt||i.skyrimini||i.skyrimprefsini)&&(i.list=void 0,i.modlisttxt=void 0,i.skyrimini=void 0,i.skyrimprefsini=void 0),i.plugins=e.body.plugins,i.modlist=e.body.modlist,i.ini=e.body.ini,i.prefsini=e.body.prefsini,i.skse=e.body.skse,i.enblocal=e.body.enblocal,i.enb=e.body.enb,i.game=e.body.game,i.tag=e.body.tag,i.timestamp=Date.now(),i.save(function(e){e?(n.statusCode=500,n.write("Saving to server failed"),n.end()):(n.statusCode=200,n.write("Access denied, incorrect password"),n.end())})):(n.statusCode=403,n.write("Access denied, incorrect password"),n.end());else{var s=new Modlist;s.plugins=e.body.plugins,s.modlist=e.body.modlist,s.ini=e.body.ini,s.prefsini=e.body.prefsini,s.skse=e.body.skse,s.enblocal=e.body.enblocal,s.enb=e.body.enb,s.game=e.body.game,s.tag=e.body.tag,s.timestamp=Date.now(),s.username=e.body.username,s.password=s.generateHash(e.body.password),s.save(function(e){e?(n.statusCode=500,n.end()):(n.statusCode=200,n.end())})}})}),e.post("/fullloadorder",function(e,n){Modlist.findOne({username:e.body.username},function(t,i){if(i)i.validPassword(e.body.password)?(i.plugins=i.updateFile(e.body.plugins,"plugins"),i.modlist=i.updateFile(e.body.modlisttxt,"modlist"),i.ini=i.updateFile(e.body.skyrimini,"ini"),i.prefsini=i.updateFile(e.body.skyrimprefsini,"prefsini"),i.timestamp=Date.now(),i.save(function(e){e?(n.statusCode=500,n.end()):(n.statusCode=200,n.end())})):(n.statusCode=403,n.write("Access denied, incorrect password"),n.end());else{var s=new Modlist;s.plugins=s.updateFile(e.body.plugins,"plugins"),s.modlist=s.updateFile(e.body.modlisttxt,"modlist"),s.ini=s.updateFile(e.body.skyrimini,"ini"),s.prefsini=s.updateFile(e.body.skyrimprefsini,"prefsini"),s.username=e.body.username,s.password=s.generateHash(e.body.password),s.timestamp=Date.now(),s.save(function(e){e?(n.statusCode=500,n.end()):(n.statusCode=200,n.end())})}})})};
//# sourceMappingURL=routes.js.map
