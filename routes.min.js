/*! modwatchapi 01-04-2015 */
function ensureAuthorized(a,b,c){var d,e=a.headers.authorization;if("undefined"!=typeof e){var f=e.split(" ");d=f[1],a.token=d,c(a,b)}else b.send(403)}module.exports=function(a,b,c,d,e){a.get("/api/users/count",b(d),function(a,b){Modlist.find({},{_id:1},function(a,c){c?(b.set("Content-Type","text/plain"),b.send(""+c.length)):(b.writeHead(404),b.end())})}),a.get("/",function(a,b){b.send('<html><body><form action="/auth/signin" method="POST"><input name="username"/><input type="password" name="password"/><input type="submit"/></form></body></html>')}),a.get("/api/users/list",b(d),function(a,b){Modlist.find({},{username:1},function(a,c){for(var d=[],e=c.length-1,f=0;e>=0;e--,f++)d[f]=c[e].username;b.set("Content-Type","text/json"),b.send({usernames:d})})}),a.get("/api/script/version",b(d),function(a,b){b.set("Content-Type","text"),b.send(e)}),a.get("/api/user/:username/plugins",b(d),function(a,b){Modlist.findOne({username:a.params.username},{plugins:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.plugins))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/modlist",b(d),function(a,b){Modlist.findOne({username:a.params.username},{modlist:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.modlist))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/ini",b(d),function(a,b){Modlist.findOne({username:a.params.username},{ini:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.ini))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/prefsini",b(d),function(a,b){Modlist.findOne({username:a.params.username},{prefsini:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.prefsini))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/skse",b(d),function(a,b){Modlist.findOne({username:a.params.username},{skse:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.skse))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/enblocal",b(d),function(a,b){Modlist.findOne({username:a.params.username},{enblocal:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.enblocal))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/profile",b(d),function(a,b){Modlist.findOne({username:a.params.username},{tag:1,enb:1,badge:1,timestamp:1,game:1,_id:0},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/files",b(d),function(a,b){Modlist.findOne({username:a.params.username},{plugins:1,modlist:1,ini:1,prefsini:1,skse:1,enblocal:1,_id:0},function(a,c){if(c){b.setHeader("Content-Type","application/json");var d=[];c.plugins.length>0&&d.push("plugins"),c.modlist.length>0&&d.push("modlist"),c.ini.length>0&&d.push("ini"),c.prefsini.length>0&&d.push("prefsini"),c.skse.length>0&&d.push("skse"),c.enblocal.length>0&&d.push("enblocal"),b.end(JSON.stringify(d))}else b.writeHead(404),b.end()})}),a.get("/api/search/modlist/:querystring",b(d),function(a,b){Modlist.find({},{modlist:1,username:1},function(c,d){for(var e,f=[],g=a.params.querystring.toLowerCase(),h=0;d&&h<d.length;h++)for(var i=0;i<d[h].modlist.length;i++)if(e=d[h].modlist[i].name.toLowerCase(),e.indexOf(g)>=0){f.push(d[h].username);break}b.setHeader("Content-Type","application/json"),b.end(JSON.stringify({users:f,length:f.length}))})}),a.post("/auth/checkToken",b(d),function(a,b){c.verify(a.body.token,process.env.JWTSECRET,function(a,c){a?(b.writeHead(403),b.end()):(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify({username:c.username})))})}),a.post("/auth/signin",b(d),function(a,b){Modlist.findOne({username:a.body.username},function(d,e){d?(b.writeHead(500),b.end()):e&&e.validPassword(a.body.password)?(e.pic=c.sign({username:e.username,password:e.password},process.env.JWTSECRET,{expiresInMinutes:720}),e.save(function(a,c){a?(b.writeHead(500),b.end()):b.json({token:c.pic})})):(console.log(a.body.username),b.writeHead(403),b.end())})}),a.post("/newTag/:username",b(d),ensureAuthorized,function(a,b){c.verify(a.token,JWTSECRET,function(c){c?(b.writeHead(403),b.end()):Modlist.findOne({username:a.params.username},function(c,d){d?(d.tag=a.body.tag,d.save(function(a){a?(console.log(a),b.writeHead(500),b.end()):(b.statusCode=200,b.end())})):(b.writeHead(404),b.end())})})}),a.post("/newENB/:username",b(d),ensureAuthorized,function(a,b){c.verify(a.token,JWTSECRET,function(c){c?(b.writeHead(403),b.end()):Modlist.findOne({username:a.params.username},function(c,d){d?(d.enb=a.body.enb,d.save(function(a){a?(console.log(a),b.writeHead(500),b.end()):(b.statusCode=200,b.end())})):(b.writeHead(404),b.end())})})})};var Modlist=require("./modlist.min.js");