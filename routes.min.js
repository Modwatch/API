/*! modwatchapi 23-04-2015 */
function ensureAuthorized(a,b,c){var d,e=a.headers.authorization;if("undefined"!=typeof e){var f=e.split(" ");d=f[1],a.token=d,c(a,b)}else b.send(403)}module.exports=function(a,b,c){a.get("/api/users/count",function(a,b){Modlist.find({},{_id:1},function(a,c){c?(b.set("Content-Type","text/plain"),b.send(""+c.length)):(b.writeHead(404),b.end())})}),a.get("/api/users/list",function(a,b){Modlist.find({},{username:1},function(a,c){for(var d=[],e=c.length-1,f=0;e>=0;e--,f++)d[f]=c[e].username;b.set("Content-Type","text/json"),b.send({usernames:d})})}),a.get("/api/script/version",function(a,b){b.set("Content-Type","text"),b.send(c)}),a.get("/api/user/:username/plugins",function(a,b){Modlist.findOne({username:a.params.username},{plugins:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.plugins))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/modlist",function(a,b){Modlist.findOne({username:a.params.username},{modlist:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.modlist))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/ini",function(a,b){Modlist.findOne({username:a.params.username},{ini:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.ini))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/prefsini",function(a,b){Modlist.findOne({username:a.params.username},{prefsini:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.prefsini))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/skse",function(a,b){Modlist.findOne({username:a.params.username},{skse:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.skse))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/enblocal",function(a,b){Modlist.findOne({username:a.params.username},{enblocal:1},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c.enblocal))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/profile",function(a,b){Modlist.findOne({username:a.params.username},{tag:1,enb:1,badge:1,timestamp:1,game:1,_id:0},function(a,c){c?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(c))):(b.writeHead(404),b.end())})}),a.get("/api/user/:username/files",function(a,b){Modlist.findOne({username:a.params.username},{plugins:1,modlist:1,ini:1,prefsini:1,skse:1,enblocal:1,_id:0},function(a,c){if(c){b.setHeader("Content-Type","application/json");var d=[];c.plugins.length>0&&d.push("plugins"),c.modlist.length>0&&d.push("modlist"),c.ini.length>0&&d.push("ini"),c.prefsini.length>0&&d.push("prefsini"),c.skse.length>0&&d.push("skse"),c.enblocal.length>0&&d.push("enblocal"),b.end(JSON.stringify(d))}else b.writeHead(404),b.end()})}),a.get("/api/search/modlist/:querystring",function(a,b){Modlist.find({},{modlist:1,username:1},function(c,d){for(var e,f=[],g=a.params.querystring.toLowerCase(),h=0;d&&h<d.length;h++)for(var i=0;i<d[h].modlist.length;i++)if(e=d[h].modlist[i].name.toLowerCase(),e.indexOf(g)>=0){f.push(d[h].username);break}b.setHeader("Content-Type","application/json"),b.end(JSON.stringify({users:f,length:f.length}))})}),a.post("/auth/checkToken",function(a,c){b.verify(a.body.token,process.env.JWTSECRET,function(a,b){a?(c.writeHead(403),c.end()):(c.setHeader("Content-Type","application/json"),c.end(JSON.stringify({username:b.username})))})}),a.post("/auth/signin",function(a,c){Modlist.findOne({username:a.body.username},function(d,e){d?(c.writeHead(500),c.end()):e&&e.validPassword(a.body.password)?(e.pic=b.sign({username:e.username,password:e.password},process.env.JWTSECRET,{expiresInMinutes:720}),e.save(function(a,b){a?(c.writeHead(500),c.end()):c.json({token:b.pic})})):(console.log(a.body.username),c.writeHead(403),c.end())})}),a.post("/api/newTag/:username",ensureAuthorized,function(a,c){b.verify(a.token,JWTSECRET,function(b){b?(c.writeHead(403),c.end()):Modlist.findOne({username:a.params.username},function(b,d){d?(d.tag=a.body.tag,d.save(function(a){a?(c.writeHead(500),c.end()):(c.statusCode=200,c.end())})):(c.writeHead(404),c.end())})})}),a.post("/api/newENB/:username",ensureAuthorized,function(a,c){console.log("hello?"),b.verify(a.token,JWTSECRET,function(b){b?(c.writeHead(403),c.end()):Modlist.findOne({username:a.params.username},function(b,d){d?(d.enb=a.body.enb,d.save(function(a){a?(c.writeHead(500),c.end()):(c.statusCode=200,c.end())})):(c.writeHead(404),c.end())})})})};var Modlist=require("./modlist.min.js");